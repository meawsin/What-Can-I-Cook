<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Snack Recipes - What Can I Cook?</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
      body { background-color: #fdf1c1; }
      .modal { background-color: rgba(0, 0, 0, 0.5); }
      .loading-spinner { border: 2px solid #f3f3f3; border-top: 2px solid #f59e0b; border-radius: 50%; width: 16px; height: 16px; animation: spin 1s linear infinite; }
      @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
  </head>
  <body class="min-h-screen text-black">
    <div class="flex flex-col md:flex-row">
      <script defer>
      function toggleDropdown(id) {
        const menu = document.getElementById(id);
        menu.classList.toggle('hidden');
      }

      function toggleSidebar() {
        const sidebar = document.getElementById('sidebar');
        sidebar.classList.toggle('-translate-x-full');
      }

      function submitCategories() {
        const checkboxes = document.querySelectorAll('#categoryForm input[name="category"]:checked');
        const selected = Array.from(checkboxes).map(cb => cb.value);
        const resultDiv = document.getElementById('categoryResult');

        if (selected.length > 0) {
          resultDiv.innerText = 'Showing recipes for: ' + selected.join(', ');
          resultDiv.classList.remove('hidden');
        } else {
          resultDiv.innerText = 'Please select at least one category.';
          resultDiv.classList.remove('hidden');
        }
      }

      function submitMealTypes() {
        const checkboxes = document.querySelectorAll('#mealTypeForm input[name="mealtype"]:checked');
        const selected = Array.from(checkboxes).map(cb => cb.value);
        const resultDiv = document.getElementById('mealResult');

        if (selected.length > 0) {
          resultDiv.innerText = 'Showing meal types: ' + selected.join(', ');
          resultDiv.classList.remove('hidden');
        } else {
          resultDiv.innerText = 'Please select at least one meal type.';
          resultDiv.classList.remove('hidden');
        }
      }

      // Function to check authentication status
      function checkAuthStatus() {
        const token = localStorage.getItem('token');
        const userInfo = localStorage.getItem('userInfo');
        
        if (!token || !userInfo) {
          return false;
        }
        
        try {
          const user = JSON.parse(userInfo);
          if (!user || !user.token) {
            return false;
          }
          return true;
        } catch (error) {
          return false;
        }
      }

      // Function to handle navigation based on auth status
      function navigateHome() {
        const isAuthenticated = checkAuthStatus();
        if (isAuthenticated) {
          window.location.href = 'home.html';
        } else {
          window.location.href = 'index.html';
        }
      }

      // This code runs when the page is loaded
      document.addEventListener('DOMContentLoaded', () => {
        const isAuthenticated = checkAuthStatus();
        
        // Update the home button to use the correct navigation
        const homeButton = document.querySelector('a[href="index.html"]');
        if (homeButton) {
          homeButton.onclick = function(e) {
            e.preventDefault();
            navigateHome();
          };
        }
      });
    </script>
  </head>
  <body class="min-h-screen bg-white text-black">
    <div class="flex flex-col md:flex-row">
      <!-- Sidebar -->
      <div id="sidebar" class="fixed md:relative z-30 transform -translate-x-full md:translate-x-0 transition-transform duration-300 w-64 min-h-screen bg-black p-6 flex flex-col rounded-br-3xl">
        <div class="flex items-center mb-6">
          <img src="logo-removebg.png" alt="Logo" class="w-20 h-20 object-contain filter invert">
          <h1 class="text-xl font-semibold tracking-wide text-white ml-3">What Can I Cook?</h1>
        </div>
        <input type="text" placeholder="Search by Ingredients" class="w-full px-3 py-2 rounded-md text-black mb-4" />
        <nav class="space-y-4">
          <a href="home.html" class="block text-white text-lg hover:text-yellow-500">HOME</a>
          <div>
            <button onclick class="flex items-center text-white hover:text-yellow-500 text-lg w-full"></button>
            <div>
             <a href="recipes.html" class="block text-white text-lg hover:text-yellow-500">All Recipes</a>
            <button onclick class="flex items-center text-white hover:text-yellow-500 text-lg w-full"></button>
        
              
            </div>
          </div>
          <a href="favourites.html" class="block text-white text-lg hover:text-yellow-500">FAVOURITES</a>
          <a href="about.html" class="block text-white text-lg hover:text-yellow-500">ABOUT US</a>
          <a href="login.html" class="block text-white text-lg hover:text-yellow-500">LOGOUT</a>
        </nav>
      </div>

      <!-- Topbar + Content -->
      <div class="flex-1">
        <div class="flex items-center justify-between p-4 shadow-md bg-black text-white">
          <button onclick="toggleSidebar()" class="text-3xl">☰</button>
          <input type="text" placeholder="Search By Ingredients" class="w-full md:w-1/2 px-4 py-2 rounded-full border border-gray-300 text-black" />
        </div>
      <!-- Main content -->
      <div class="flex-1 p-6">
        <!-- Header -->
        <header class="bg-yellow-500 text-white py-4 shadow mb-6">
          <div class="max-w-6xl mx-auto px-6 flex justify-between items-center">
            <h1 class="text-3xl font-bold">Snack Recipes</h1>
            <a href="#" onclick="navigateHome(); return false;" class="bg-white text-yellow-600 font-bold px-4 py-2 rounded hover:bg-yellow-100">← Home</a>
          </div>
        </header>
        
        <h2 class="text-4xl text-center font-bold text-yellow-600 mb-6">Snacks</h2>
        <div class="mb-8">
          <input
            type="text"
            id="searchInput"
            oninput="filterRecipes()"
            placeholder="Search by ingredient..."
            class="w-full max-w-md px-4 py-2 border border-yellow-300 rounded-full focus:outline-none focus:ring-2 focus:ring-yellow-500"
          />
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
          <div class="bg-white p-4 rounded-xl shadow-md">
            <img src="samosa.jpg" alt="Samosa" class="w-full h-40 object-cover rounded-lg mb-2">
            <h3 class="text-xl font-semibold text-yellow-600">Spicy Beef Samosa</h3>
            <p class="text-sm text-gray-700">Crispy Bangladeshi-style samosas filled with spicy beef and herbs. Perfect with a cup of tea.</p>
            <button 
      class="mt-4 px-4 py-2 bg-yellow-500 text-white text-sm font-medium rounded hover:bg-yellow-600 transition-colors duration-200"
      data-id="123" 
      onclick="showRecipe(this)">
      Show Full Recipe
    </button>
          </div>

          <div class="bg-white p-4 rounded-xl shadow-md">
            <img src="falafel.jpg" alt="Falafel" class="w-full h-40 object-cover rounded-lg mb-2">
            <h3 class="text-xl font-semibold text-yellow-600">Falafel Bites</h3>
            <p class="text-sm text-gray-700">Middle Eastern deep-fried chickpea patties served with tahini sauce and fresh veggies.</p>
            <button 
      class="mt-4 px-4 py-2 bg-yellow-500 text-white text-sm font-medium rounded hover:bg-yellow-600 transition-colors duration-200"
      data-id="123" 
      onclick="showRecipe(this)">
      Show Full Recipe
    </button>
          </div>

          <div class="bg-white p-4 rounded-xl shadow-md">
            <img src="arancini.jpg" alt="Arancini" class="w-full h-40 object-cover rounded-lg mb-2">
            <h3 class="text-xl font-semibold text-yellow-600">Cheesy Arancini</h3>
            <p class="text-sm text-gray-700">Italian rice balls filled with mozzarella, coated in breadcrumbs, and fried to golden perfection.</p>
            <button 
      class="mt-4 px-4 py-2 bg-yellow-500 text-white text-sm font-medium rounded hover:bg-yellow-600 transition-colors duration-200"
      data-id="123" 
      onclick="showRecipe(this)">
      Show Full Recipe
    </button>
          </div>

          <div class="bg-white p-4 rounded-xl shadow-md">
  <img src="nachos.jpg" alt="Loaded Nachos" class="w-full h-40 object-cover rounded-lg mb-2">
  <h3 class="text-xl font-semibold text-yellow-600">Loaded Nachos</h3>
  <p class="text-sm text-gray-700">Crispy tortilla chips topped with cheese, jalapeños, beans, and salsa.</p>
  <button class="mt-4 px-4 py-2 bg-yellow-500 text-white text-sm font-medium rounded hover:bg-yellow-600 transition-colors duration-200" onclick="showRecipe(this)">Show Full Recipe</button>
</div>

<div class="bg-white p-4 rounded-xl shadow-md">
  <img src="momos.jpg" alt="Steamed Momos" class="w-full h-40 object-cover rounded-lg mb-2">
  <h3 class="text-xl font-semibold text-yellow-600">Steamed Momos</h3>
  <p class="text-sm text-gray-700">Tibetan dumplings stuffed with spiced chicken or vegetables, served with hot chutney.</p>
  <button class="mt-4 px-4 py-2 bg-yellow-500 text-white text-sm font-medium rounded hover:bg-yellow-600 transition-colors duration-200" onclick="showRecipe(this)">Show Full Recipe</button>
</div>

<div class="bg-white p-4 rounded-xl shadow-md">
  <img src="cornfritters.jpg" alt="Corn Fritters" class="w-full h-40 object-cover rounded-lg mb-2">
  <h3 class="text-xl font-semibold text-yellow-600">Corn Fritters</h3>
  <p class="text-sm text-gray-700">Golden, crispy corn fritters packed with sweet corn and herbs.</p>
  <button class="mt-4 px-4 py-2 bg-yellow-500 text-white text-sm font-medium rounded hover:bg-yellow-600 transition-colors duration-200" onclick="showRecipe(this)">Show Full Recipe</button>
</div>

<div class="bg-white p-4 rounded-xl shadow-md">
  <img src="chickenpopcorn.jpg" alt="Chicken Popcorn" class="w-full h-40 object-cover rounded-lg mb-2">
  <h3 class="text-xl font-semibold text-yellow-600">Crispy Chicken Popcorn</h3>
  <p class="text-sm text-gray-700">Bite-sized crispy chicken pieces seasoned with bold spices – addictive snack!</p>
  <button class="mt-4 px-4 py-2 bg-yellow-500 text-white text-sm font-medium rounded hover:bg-yellow-600 transition-colors duration-200" onclick="showRecipe(this)">Show Full Recipe</button>
</div>

<div class="bg-white p-4 rounded-xl shadow-md">
  <img src="onionrings.jpg" alt="Onion Rings" class="w-full h-40 object-cover rounded-lg mb-2">
  <h3 class="text-xl font-semibold text-yellow-600">Crispy Onion Rings</h3>
  <p class="text-sm text-gray-700">Thick-cut onion rings battered and deep-fried until golden and crunchy.</p>
  <button class="mt-4 px-4 py-2 bg-yellow-500 text-white text-sm font-medium rounded hover:bg-yellow-600 transition-colors duration-200" onclick="showRecipe(this)">Show Full Recipe</button>
</div>

<div class="bg-white p-4 rounded-xl shadow-md">
  <img src="bananachips.jpg" alt="Banana Chips" class="w-full h-40 object-cover rounded-lg mb-2">
  <h3 class="text-xl font-semibold text-yellow-600">Banana Chips</h3>
  <p class="text-sm text-gray-700">Thinly sliced green bananas fried until crispy and lightly salted.</p>
  <button class="mt-4 px-4 py-2 bg-yellow-500 text-white text-sm font-medium rounded hover:bg-yellow-600 transition-colors duration-200" onclick="showRecipe(this)">Show Full Recipe</button>
</div>

<div class="bg-white p-4 rounded-xl shadow-md">
  <img src="deviledeggs.jpg" alt="Deviled Eggs" class="w-full h-40 object-cover rounded-lg mb-2">
  <h3 class="text-xl font-semibold text-yellow-600">Classic Deviled Eggs</h3>
  <p class="text-sm text-gray-700">Hard-boiled eggs with creamy mustard filling, a classic finger food.</p>
  <button class="mt-4 px-4 py-2 bg-yellow-500 text-white text-sm font-medium rounded hover:bg-yellow-600 transition-colors duration-200" onclick="showRecipe(this)">Show Full Recipe</button>
</div>

<div class="bg-white p-4 rounded-xl shadow-md">
  <img src="cheesetwists.jpg" alt="Cheese Twists" class="w-full h-40 object-cover rounded-lg mb-2">
  <h3 class="text-xl font-semibold text-yellow-600">Puff Cheese Twists</h3>
  <p class="text-sm text-gray-700">Flaky puff pastry twisted with cheddar – easy, cheesy snack delight.</p>
  <button class="mt-4 px-4 py-2 bg-yellow-500 text-white text-sm font-medium rounded hover:bg-yellow-600 transition-colors duration-200" onclick="showRecipe(this)">Show Full Recipe</button>
</div>

<div class="bg-white p-4 rounded-xl shadow-md">
  <img src="garlicbread.jpg" alt="Garlic Bread" class="w-full h-40 object-cover rounded-lg mb-2">
  <h3 class="text-xl font-semibold text-yellow-600">Garlic Bread</h3>
  <p class="text-sm text-gray-700">Buttery bread slices toasted with garlic and herbs – best served warm.</p>
  <button class="mt-4 px-4 py-2 bg-yellow-500 text-white text-sm font-medium rounded hover:bg-yellow-600 transition-colors duration-200" onclick="showRecipe(this)">Show Full Recipe</button>
</div>

<div class="bg-white p-4 rounded-xl shadow-md">
  <img src="stuffedmushrooms.jpg" alt="Stuffed Mushrooms" class="w-full h-40 object-cover rounded-lg mb-2">
  <h3 class="text-xl font-semibold text-yellow-600">Stuffed Mushrooms</h3>
  <p class="text-sm text-gray-700">Mushroom caps stuffed with herbed cream cheese and breadcrumbs, then baked.</p>
  <button class="mt-4 px-4 py-2 bg-yellow-500 text-white text-sm font-medium rounded hover:bg-yellow-600 transition-colors duration-200" onclick="showRecipe(this)">Show Full Recipe</button>
</div>


          <div class="bg-white p-4 rounded-xl shadow-md">
            <img src="pakora.jpg" alt="Pakora" class="w-full h-40 object-cover rounded-lg mb-2">
            <h3 class="text-xl font-semibold text-yellow-600">Vegetable Pakora</h3>
            <p class="text-sm text-gray-700">Assorted veggies dipped in seasoned gram flour batter and fried till crispy.</p>
            <button 
      class="mt-4 px-4 py-2 bg-yellow-500 text-white text-sm font-medium rounded hover:bg-yellow-600 transition-colors duration-200"
      data-id="123" 
      onclick="showRecipe(this)">
      Show Full Recipe
    </button>
          </div>

          <div class="bg-white p-4 rounded-xl shadow-md">
            <img src="cheeseballs.jpg" alt="Cheese Balls" class="w-full h-40 object-cover rounded-lg mb-2">
            <h3 class="text-xl font-semibold text-yellow-600">Cheese Balls</h3>
            <p class="text-sm text-gray-700">Crispy on the outside, gooey on the inside – a hit Italian snack for any party!</p>
            <button 
      class="mt-4 px-4 py-2 bg-yellow-500 text-white text-sm font-medium rounded hover:bg-yellow-600 transition-colors duration-200"
      data-id="123" 
      onclick="showRecipe(this)">
      Show Full Recipe
    </button>
          </div>

          <div class="bg-white p-4 rounded-xl shadow-md">
            <img src="springroll.jpg" alt="Spring Roll" class="w-full h-40 object-cover rounded-lg mb-2">
            <h3 class="text-xl font-semibold text-yellow-600">Chicken Spring Rolls</h3>
            <p class="text-sm text-gray-700">Thin crispy rolls filled with chicken and veggies, served with sweet chili sauce.</p>
            <button 
      class="mt-4 px-4 py-2 bg-yellow-500 text-white text-sm font-medium rounded hover:bg-yellow-600 transition-colors duration-200"
      data-id="123" 
      onclick="showRecipe(this)">
      Show Full Recipe
    </button>
          </div>
<footer class="footer">
    <p class="px-2 py-6 text-xl text-center">© 2025 What Can I Cook? All rights reserved.</p>
  </footer>
        </div>
      </div>
    </div>

    <script>
      const recipesGrid = document.getElementById('recipes-grid');
      const loadingSkeleton = document.getElementById('loading-skeleton');
      const allergySection = document.getElementById('allergy-section');
      const allergyNote = document.getElementById('allergy-note');
      let allRecipes = []; // To store a copy of all recipes for client-side search
      let userFavorites = []; // To store the IDs of the user's favorite recipes
      let token = localStorage.getItem('token'); // Check for token once at the start

      // Function to check authentication status
      function checkAuthStatus() {
        const token = localStorage.getItem('token');
        const userInfo = localStorage.getItem('userInfo');
        
        if (!token || !userInfo) {
          return false;
        }
        
        try {
          const user = JSON.parse(userInfo);
          if (!user || !user.token) {
            return false;
          }
          return true;
        } catch (error) {
          return false;
        }
      }

      // Function to handle navigation based on auth status
      function navigateHome() {
        const isAuthenticated = checkAuthStatus();
        if (isAuthenticated) {
          window.location.href = 'home.html';
        } else {
          window.location.href = 'index.html';
        }
      }

      // Function to clear all filters
      function clearFilters() {
        document.getElementById('cuisine-input').value = '';
        document.getElementById('search-input').value = '';
        document.getElementById('allergy-input').value = '';
        allergyNote.classList.add('hidden');
        applyFilters();
      }

      // Function to logout
      function logout() {
        localStorage.removeItem('token');
        localStorage.removeItem('userInfo');
        token = null;
        userFavorites = [];
        window.location.href = 'index.html';
      }

      // Function to show the recipe modal
      function showRecipe(title, ingredients, procedure) {
        document.getElementById('modalTitle').textContent = title;
        document.getElementById('modalIngredients').innerHTML = ingredients.map(i => `<li>${i}</li>`).join('');
        document.getElementById('modalProcedure').textContent = procedure;
        document.getElementById('recipeModal').classList.remove('hidden');
      }

      // Function to close the recipe modal
      function closeRecipe() {
        document.getElementById('recipeModal').classList.add('hidden');
      }

      // Function to handle toggling a favorite recipe
      async function toggleFavorite(recipeId, buttonElement) {
        // Check authentication status before proceeding
        if (!checkAuthStatus()) {
          alert('You must be logged in to save recipes.');
          window.location.href = 'login.html';
          return;
        }

        // Show loading state on button
        const originalText = buttonElement.textContent;
        buttonElement.disabled = true;
        buttonElement.innerHTML = '<div class="loading-spinner"></div>';

        try {
          const response = await fetch(`/api/users/favorites/${recipeId}`, {
            method: 'PUT',
            headers: { 'Authorization': `Bearer ${token}` }
          });

          if (response.status === 401) {
            // Token is invalid, logout user
            logout();
            return;
          }

          if (response.ok) {
            // Update the button's appearance and the userFavorites array
            const index = userFavorites.indexOf(recipeId);
            if (index > -1) {
              userFavorites.splice(index, 1); // Unfavorited
              buttonElement.textContent = '❤️ Save';
              buttonElement.classList.remove('saved', 'bg-green-500');
              buttonElement.classList.add('bg-pink-500');
            } else {
              userFavorites.push(recipeId); // Favorited
              buttonElement.textContent = '💚 Saved';
              buttonElement.classList.add('saved', 'bg-green-500');
              buttonElement.classList.remove('bg-pink-500');
            }
          } else {
            alert('Failed to update favorites.');
          }
        } catch (error) {
          console.error('Error toggling favorite:', error);
          alert('An error occurred while updating favorites.');
        } finally {
          buttonElement.disabled = false;
        }
      }

      // Function to render recipes to the page
      function renderRecipes(recipes) {
        // Hide loading skeleton
        loadingSkeleton.classList.add('hidden');
        
        recipesGrid.innerHTML = ''; // Clear existing recipes
        if (recipes.length === 0) {
          recipesGrid.innerHTML = `
            <div class="col-span-full text-center py-12">
              <div class="text-gray-500 text-lg mb-4">🍽️</div>
              <p class="text-gray-600 text-lg">No snack recipes found matching your criteria.</p>
              <p class="text-gray-500 text-sm mt-2">Try adjusting your filters or search terms.</p>
            </div>
          `;
          return;
        }

        recipes.forEach(recipe => {
          const card = document.createElement('div');
          card.className = 'bg-white rounded-lg shadow hover:shadow-xl transition duration-300 overflow-hidden';
          
          // Handle missing or invalid data gracefully
          const title = recipe.title || 'Untitled Recipe';
          const description = recipe.description || 'No description available';
          const ingredients = Array.isArray(recipe.ingredients) ? recipe.ingredients : [];
          const instructions = recipe.instructions || 'No instructions available';
          const imageUrl = recipe.imageUrl || 'images/placeholder_recipe.jpg';
          const uploadedBy = recipe.uploadedBy ? (recipe.uploadedBy.username || 'Unknown') : 'Unknown';
          
          const ingredientsString = JSON.stringify(ingredients);
          const isFavorite = userFavorites.includes(recipe._id);
          const favoriteButtonText = isFavorite ? '💚 Saved' : '❤️ Save';
          const favoriteButtonClass = isFavorite ? 'saved bg-green-500' : 'bg-pink-500';
          
          let favoriteButtonHTML = '';
          if (token && checkAuthStatus()) {
            favoriteButtonHTML = `
              <button onclick="toggleFavorite('${recipe._id}', this)" 
                class="ml-2 text-sm px-3 py-1 text-white rounded hover:bg-opacity-80 ${favoriteButtonClass}">
                ${favoriteButtonText}
              </button>
            `;
          }

          card.innerHTML = `
            <img src="${imageUrl}" alt="${title}" class="w-full h-48 object-cover" onerror="this.src='images/placeholder_recipe.jpg'">
            <div class="p-4">
              <h3 class="text-xl font-semibold mb-2">${title}</h3>
              <p class="text-gray-700 text-sm mb-3">${description}</p>
              <p class="text-xs text-gray-500 mb-3">Uploaded by: ${uploadedBy}</p>
              <div class="flex justify-between items-center">
                <button onclick='showRecipe("${title.replace(/'/g, "\\'")}", ${ingredientsString}, "${instructions.replace(/"/g, '&quot;').replace(/'/g, "\\'")}")' 
                  class="text-sm px-3 py-1 bg-yellow-500 text-white rounded hover:bg-yellow-600">🍽 View Recipe</button>
                ${favoriteButtonHTML}
              </div>
            </div>
          `;
          recipesGrid.appendChild(card);
        });
      }

      // Function to fetch the logged-in user's favorites
      async function fetchUserFavorites() {
        if (!checkAuthStatus()) return;
        
        try {
          const response = await fetch('/api/users/favorites', {
            headers: { 'Authorization': `Bearer ${token}` }
          });
          
          if (response.status === 401) {
            // Token is invalid, logout user
            logout();
            return;
          }
          
          if (response.ok) {
            const favorites = await response.json();
            userFavorites = favorites.map(fav => fav._id); // Store only the IDs for quick lookup
          }
        } catch (error) {
          console.error('Could not fetch user favorites:', error);
        }
      }

      // Function to fetch snack recipes from the backend
      async function fetchSnackRecipes() {
        await fetchUserFavorites(); // Load user favorites first
        try {
          const response = await fetch('/api/recipes?mealType=Snacks');
          if (!response.ok) throw new Error('Network response was not ok');
          allRecipes = await response.json();
          renderRecipes(allRecipes);
        } catch (error) {
          console.error('Failed to fetch snack recipes:', error);
          loadingSkeleton.innerHTML = `
            <div class="col-span-full text-center py-12">
              <div class="text-red-500 text-lg mb-4">❌</div>
              <p class="text-red-600 text-lg">Failed to load snack recipes.</p>
              <p class="text-gray-500 text-sm mt-2">Please try again later.</p>
              <button onclick="location.reload()" class="mt-4 bg-yellow-500 text-white px-4 py-2 rounded hover:bg-yellow-600">
                Retry
              </button>
            </div>
          `;
        }
      }
      
      // Function to handle filtering with allergy support
      function applyFilters() {
          const mealType = 'Snacks'; // Fixed for snacks page
          const cuisine = document.getElementById('cuisine-input').value.toLowerCase();
          const searchTerm = document.getElementById('search-input').value.toLowerCase();
          const allergyFilter = document.getElementById('allergy-input').value.toLowerCase();

          let filteredRecipes = allRecipes.filter(recipe => {
              const matchesMeal = recipe.mealType && recipe.mealType === mealType;
              const matchesCuisine = !cuisine || (recipe.cuisine && recipe.cuisine.toLowerCase().includes(cuisine));
              const matchesSearch = !searchTerm || 
                                    recipe.title.toLowerCase().includes(searchTerm) ||
                                    recipe.ingredients.some(ing => ing.toLowerCase().includes(searchTerm));
              
              // Allergy filtering (only for logged-in users)
              let matchesAllergy = true;
              if (allergyFilter && checkAuthStatus()) {
                  const ingredients = recipe.ingredients.map(ing => ing.toLowerCase());
                  const allergyKeywords = {
                      'nuts': ['nuts', 'almond', 'walnut', 'peanut', 'cashew', 'pecan'],
                      'dairy': ['milk', 'cheese', 'cream', 'butter', 'yogurt', 'dairy'],
                      'eggs': ['egg', 'eggs'],
                      'gluten': ['wheat', 'gluten', 'flour', 'bread', 'pasta'],
                      'shellfish': ['shrimp', 'crab', 'lobster', 'shellfish'],
                      'soy': ['soy', 'soya'],
                      'wheat': ['wheat', 'flour', 'bread', 'pasta']
                  };
                  
                  if (allergyKeywords[allergyFilter]) {
                      matchesAllergy = !allergyKeywords[allergyFilter].some(keyword => 
                          ingredients.some(ing => ing.includes(keyword))
                      );
                  }
              }
              
              return matchesMeal && matchesCuisine && matchesSearch && matchesAllergy;
          });

          // Show allergy note if filter is applied
          if (allergyFilter && checkAuthStatus()) {
              const excludedCount = allRecipes.length - filteredRecipes.length;
              const allergyNames = {
                  'nuts': 'nuts',
                  'dairy': 'dairy products',
                  'eggs': 'eggs',
                  'gluten': 'gluten',
                  'shellfish': 'shellfish',
                  'soy': 'soy',
                  'wheat': 'wheat'
              };
              allergyNote.innerHTML = `You said you have allergy on <strong>${allergyNames[allergyFilter]}</strong>, so we have removed <strong>${excludedCount}</strong> recipes.`;
              allergyNote.classList.remove('hidden');
          } else {
              allergyNote.classList.add('hidden');
          }

          renderRecipes(filteredRecipes);
      }

      // Add event listeners to all filter controls
      document.querySelectorAll('.filter-control').forEach(control => {
          control.addEventListener('input', applyFilters);
          control.addEventListener('change', applyFilters);
      });

      // This code runs when the page is loaded
      document.addEventListener('DOMContentLoaded', () => {
        const isAuthenticated = checkAuthStatus();
        
        // Show allergy section for logged-in users
        if (isAuthenticated) {
          allergySection.classList.remove('hidden');
        }
        
        fetchSnackRecipes();
      });
    </script>
  </body>
</html>
